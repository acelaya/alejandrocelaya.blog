---
import lunr from 'lunr';
import { Container } from '../components/Container';
import { SectionTitle } from '../components/SectionTitle';
import { Search } from '../components/Search';
import Layout from '../layouts/Layout.astro';
import { getAllPosts } from '../utils/posts';

const posts = await getAllPosts().then((posts) =>
  // Get rid of the `render` function, which cannot be serialized
  posts.map(({ render, ...post }) => ({
    title: post.data.title,
    ...post,
  }))
);
const index = lunr(function () {
  // Set which of the post fields have meaningful content to index
  this.field('title');
  this.field('body');

  // Lunr requires an `id` field, which posts already include
  posts.forEach(post => this.add(post));
})
const serializedIndex = index.toJSON();
const postMap = posts.reduce((acc, post) => {
  acc[post.id] = post;
  return acc;
}, {});
---

<Layout url="/search/">
  <Container className="search-section">
    <SectionTitle>Search</SectionTitle>

    <Search index={serializedIndex} posts={postMap} client:only="react" />
  </Container>
</Layout>
